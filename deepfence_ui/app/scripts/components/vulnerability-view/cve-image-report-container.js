import React from 'react';
import {connect} from 'react-redux';
import {
  nodeFilterValueSelector,
} from '../../selectors/node-filters';
import {
  xlsxReportDownloadAction,
} from '../../actions/app-actions';
import CVEImageReport from './cve-image-report';

class CVEImageReportContainer extends React.PureComponent {
  constructor(props) {
    super(props);
    this.handleDownload = this.handleDownload.bind(this);
  }

  handleDownload(params) {
    const {
      xlsxReportDownloadAction: action,
    } = this.props;

    const {
      scanId = '',
      nodeType = '',
    } = params;

    const apiParams = {
      action: 'download_report',
      node_type: nodeType,
      action_args: {
        resources: [
          {
            type: 'cve',
            filter: {
              scan_id: [
                scanId,
              ]
            }
          }
        ],
        filters: {
          type: [
            nodeType,
          ]
        }
      }
    };

    return action(apiParams);
  }

  render() {
    const {reportView, ...rest} = this.props;
    const data = reportView.get('images');
    const total = reportView.get('total');
    const {isToasterVisible} = this.props;
    return (
      <div>
        <CVEImageReport
          data={data}
          total={total}
          handleDownload={this.handleDownload}
          isToasterVisible={isToasterVisible}
          {...rest}
        />
      </div>
    );
  }
}

function mapStateToProps(state) {
  const reportView = state.getIn(['cve', 'image_report_view']);
  const savedTablePageNumber = state.getIn(['cve', 'image_report_table', 'state', 'page_number']);
  return {
    reportView,
    savedTablePageNumber,
    filterValues: nodeFilterValueSelector(state),
    isToasterVisible: state.get('isToasterVisible'),
  };
}

export default connect(mapStateToProps, {
  xlsxReportDownloadAction,
})(CVEImageReportContainer);
