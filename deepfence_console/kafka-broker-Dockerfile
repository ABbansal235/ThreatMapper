FROM confluentinc/cp-kafka:7.1.1

LABEL MAINTAINER="Deepfence Inc"
LABEL deepfence.role=system

WORKDIR /home/appuser

ENV KAFKA_BROKER_ID=1 \
    KAFKA_LISTENER_SECURITY_PROTOCOL_MAP='CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT' \
    KAFKA_ADVERTISED_LISTENERS='PLAINTEXT://deepfence-kafka-broker:29092,PLAINTEXT_HOST://localhost:9092' \
    KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1 \
    KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS=0 \
    KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1 \
    KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1 \
    KAFKA_JMX_PORT=9101 \
    KAFKA_JMX_HOSTNAME=localhost \
    KAFKA_PROCESS_ROLES='broker,controller' \
    KAFKA_NODE_ID=1 \
    KAFKA_CONTROLLER_QUORUM_VOTERS='1@deepfence-kafka-broker:29093' \
    KAFKA_LISTENERS='PLAINTEXT://deepfence-kafka-broker:29092,CONTROLLER://deepfence-kafka-broker:29093,PLAINTEXT_HOST://0.0.0.0:9092' \
    KAFKA_INTER_BROKER_LISTENER_NAME='PLAINTEXT' \
    KAFKA_CONTROLLER_LISTENER_NAMES='CONTROLLER' \
    KAFKA_LOG_DIRS='/data/kafka'

COPY kafka_update_run.sh /home/appuser/kafka_update_run.sh
CMD ["bash","-c", "/home/appuser/kafka_update_run.sh" ]
